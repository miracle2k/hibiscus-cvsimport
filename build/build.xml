<?xml version="1.0" encoding="ISO8859-1"?>

<project basedir=".." default="all" name="All">

  <target name="init" description="inits the build">

	    <property environment="env"/>

    	<property name="build.dir" value="build"/>

		<!-- read build number -->
	    <buildnumber file="${build.dir}/BUILD"/>

		<!-- read version number -->
	    <loadfile property="version" srcFile="${build.dir}/RELEASE">
			<filterchain>
				<striplinebreaks/>
			</filterchain>
		</loadfile>

		<!-- prepare cvs tag -->
		<copy file="${build.dir}/RELEASE" tofile="${build.dir}/TAG" />
		<replaceregexp flags="g" file="${build.dir}/TAG" match="\." replace="_"/>
		<loadfile property="mytag" srcFile="${build.dir}/TAG">
			<filterchain>
				<striplinebreaks/>
			</filterchain>
		</loadfile>
	    <delete file="${build.dir}/TAG" />
	    <property name="tag" value="V_${mytag}_BUILD_${build.number}"/>

	    <echo message="VERSION: ${version}"/>
    	<echo message="CVS-Tag: ${tag}"/>
	    <echo message="BUILD  : ${build.number}"/>

	    <property name="define.pluginname"    value="hbci"/>
	    <property name="define.jarfilename"   value="hibiscus.jar"/>
    	<property name="define.srcfilename"   value="hibiscus.src.zip"/>
	    <property name="define.package"       value="de.willuhn.jameica"/>

    	<property name="project.release"      value="releases/${version}-${build.number}"/>
    	<property name="project.src"          value="${project.release}/src/classes"/>
	    <property name="project.tmp"          value="${project.release}/tmp"/>
	    <property name="project.javadoc"      value="${project.release}/javadoc"/>
	    <property name="src.dir"              value="src"/>
	    <property name="icon.dir"             value="${src.dir}/img"/>
	    <property name="lang.dir"             value="${src.dir}/lang"/>
	    <property name="help.dir"             value="${src.dir}/help"/>
	    <property name="lib.dir"              value="lib"/>
	    <property name="sql.dir"              value="sql"/>
	    <property name="class.dir"            value="${project.tmp}/bin"/>

	    <property name="project.zipdir"        value="${project.release}/${define.pluginname}"/>
	    <property name="project.zipfilename"   value="${define.pluginname}.zip"/>


	    <path id="compilepath">
	      <pathelement location="../jameica/lib/swt/linux/swt.jar"/>
	      <pathelement location="../jameica/bin/"/>
	      <pathelement location="../util/bin/"/>
	      <pathelement location="../datasource/bin/"/>
	      <pathelement location="${lib.dir}/hbci4java-2.4.7pre-20040204.jar"/>
	    </path>

  </target>



  <target depends="init" name="compile" description="compiles everything">

    <mkdir dir="${class.dir}"/>

    <javac fork="true" debug="true" deprecation="true" destdir="${class.dir}" srcdir="${src.dir}">
      <classpath refid="compilepath" />
    </javac>

    <rmic verify="true" base="${class.dir}">
      <include name="**/*.class"/>
      <classpath refid="compilepath" />
    </rmic>

    <copy todir="${class.dir}/lang">
      <fileset dir="${lang.dir}" />
    </copy>
    <copy todir="${class.dir}/help">
      <fileset dir="${help.dir}" />
    </copy>
    <copy todir="${class.dir}/img">
      <fileset dir="${icon.dir}" />
    </copy>

    <copy file="${src.dir}/navigation.xml"   tofile="${class.dir}/navigation.xml" />
    <copy file="${src.dir}/menu.xml"         tofile="${class.dir}/menu.xml" />

  </target>



  <target depends="compile" name="cvstag" description="tags the source in the CVS">

    <exec executable="cvs" failonerror="true" dir="${basedir}">
      <arg line="tag ${tag}"/>
    </exec>

  </target>


  <target depends="compile" name="jar" description="generates the jar file">

    <mkdir dir="${project.release}"/>
    <mkdir dir="${project.zipdir}"/>

    <jar destfile="${project.zipdir}/${define.jarfilename}">
      <manifest>
        <attribute name="Built-By" value="${user.name}"/>
        <attribute name="Implementation-Title" value="${define.pluginname}"/>
        <attribute name="Implementation-Version" value="${version}"/>
        <attribute name="Implementation-Buildnumber" value="${build.number}"/>
        <attribute name="Class-Path" value="lang help lib lib/hbci4java-2.4.7pre-20040204.jar"/>
      </manifest>
      <fileset dir="${class.dir}"/>
    </jar>

    <mkdir dir="${project.zipdir}/sql"/>
    <copy todir="${project.zipdir}/sql">
      <fileset dir="${sql.dir}"/>
    </copy>

    <mkdir dir="${project.zipdir}/lib"/>
    <copy todir="${project.zipdir}/lib">
      <fileset dir="${lib.dir}"/>
    </copy>

    <copy file="${build.dir}/README"            tofile="${project.zipdir}/README" />
    <copy file="${build.dir}/COPYING"           tofile="${project.zipdir}/COPYING" />
    <copy file="${build.dir}/INSTALL"           tofile="${project.zipdir}/INSTALL" />


	<!-- Jetzt muessen wir noch das ZIP-File erzeugen und signieren -->
	<zip destfile="${project.release}/${project.zipfilename}">
	    <fileset dir="${project.release}">
	    	<include name="${define.pluginname}"/>
	    	<include name="${define.pluginname}/**"/>
	    </fileset>
	</zip>

  	<checksum file="${project.release}/${project.zipfilename}" />
  	<echo message="Creating PGP signature" />
  	<exec executable="kgpg" failonerror="true" timeout="60000">
		<arg line="-S ${project.release}/${project.zipfilename}"/>
  	</exec>
  	<echo message="done" />

  </target>



  <target depends="jar" name="javadoc" description="creates the api doc">

    <mkdir dir="${project.javadoc}"/>

    <javadoc destdir="${project.javadoc}" packagenames="${define.package}.*">
      <classpath refid="compilepath" />
      <sourcepath>
        <pathelement location="${src.dir}"/>
      </sourcepath>
    </javadoc>

  </target>



	<target depends="init" name="src" description="build source package, depends compile target to make sure, the code has no errors">
		<mkdir dir="${project.release}"/>
		<zip casesensitive="true" zipfile="${project.release}/${define.srcfilename}">
			<fileset dir="." >
				<include name="${src.dir}/**"/>
				<include name="${build.dir}/**"/>
				<exclude name="${build.dir}/BUILD"/>
			</fileset>
		</zip>
		<checksum file="${project.release}/${define.srcfilename}" />
		<echo message="Creating PGP signature" />
		<exec executable="kgpg" failonerror="true" timeout="60000">
			<arg line="-S ${project.release}/${define.srcfilename}"/>
		</exec>
		<echo message="done" />
	</target>



  <target name="clean" description="cleanup">
    <delete dir="${project.tmp}"/>
  </target>



  <target depends="init,compile,cvstag,jar,javadoc,src,clean" description="build an official release" name="all" />



  <target depends="init,compile,jar,src,clean" description="build inofficial release" name="fast" />


</project>
